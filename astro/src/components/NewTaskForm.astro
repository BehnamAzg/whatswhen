---
import AddPomodoroTimer from "./AddPomodoroTimer.astro";
import AddTodo from "./AddTodo.astro";
import CapsuleBtn from "./CapsuleBtn.astro";
import CapsuleBtnText from "./CapsuleBtnText.astro";
import CircleBtn from "./CircleBtn.astro";
import ColorLabel from "./ColorLabel.astro";
import IconDisplay from "./IconDisplay.astro";
import Input from "./Input.astro";
import RepeatLabel from "./RepeatLabel.astro";
---

<form id="taskForm" class="font-medium my-2 flex flex-col gap-3 focus:outline-none rounded-2xl" tabindex="-1">
  <div class="w-full flex gap-2 items-stretch">
    <!-- icon -->
    <CircleBtn svgIcon="smiley" svgSize="22" classList={["text-xl", "text-neutral-500", "backdrop-blur-none"]} action="" />
    <!-- title -->
    <Input name="title" type="text" placeholder="Title" isRequired={true} />
  </div>

  <div class="w-full flex gap-2 items-stretch">
    <!-- time -->
    <Input name="startTime" type="time" isRequired={true} classList={["w-1/2"]} />
    <!-- reminder -->
    <div class="flex-center rounded-full h-10 px-4 bg-white/50 border border-white w-1/2 gap-2">
      <h3 class="flex-center text-sm text-neutral-500">Notification</h3>
      <label class="relative inline-flex items-center cursor-pointer rounded-full ring-primary hover:ring-2 focus-within:ring-2 focus-within:ring-primary">
        <input type="checkbox" name="reminder" value="on" class="sr-only peer" />
        <div class="w-8 h-4 bg-gray-300 rounded-full peer-checked:bg-primary transition-colors"></div>
        <div class="absolute left-0.5 top-0.5 w-3 h-3 bg-white rounded-full transform peer-checked:translate-x-4 transition-transform"></div>
      </label>
    </div>
  </div>

  <div class="w-full flex gap-2 items-stretch">
    <!-- tag -->
    <Input name="tag" type="text" placeholder="Tag" />
  </div>

  <!-- Repeat -->
  <div class="w-full flex flex-wrap gap-2 items-stretch text-xs px-4 py-2.5 bg-white/50 border border-white rounded-2xl select-none text-neutral-500">
    <h3 class="flex-center text-sm text-neutral-500 mr-1">Repeat</h3>
    <RepeatLabel text="Once" role="once" isChecked={true} />
    <RepeatLabel text="Every Day" role="everyday" />
    <RepeatLabel text="Mon" role="day" value="mon" />
    <RepeatLabel text="Tue" role="day" value="tue" />
    <RepeatLabel text="Wed" role="day" value="wed" />
    <RepeatLabel text="Thu" role="day" value="thu" />
    <RepeatLabel text="Fri" role="day" value="fri" />
    <RepeatLabel text="Sat" role="day" value="sat" />
    <RepeatLabel text="Sun" role="day" value="sun" />
  </div>

  <!-- colors -->
  <div id="colorPicker" class="flex-center justify-between gap-2 rounded-full h-10 px-4 bg-white/50 border border-white flex-none">
    <ColorLabel value="bg-red-300/40" classList={["bg-red-300/50"]} />
    <ColorLabel value="bg-orange-300/40" classList={["bg-orange-300/50"]} />
    <ColorLabel value="bg-amber-300/40" classList={["bg-amber-300/50"]} isChecked={true} />
    <ColorLabel value="bg-emerald-300/40" classList={["bg-emerald-300/50"]} />
    <ColorLabel value="bg-blue-300/40" classList={["bg-blue-300/50"]} />
    <ColorLabel value="bg-fuchsia-300/40" classList={["bg-fuchsia-300/50"]} />
    <ColorLabel value="bg-pink-300/40" classList={["bg-pink-300/50"]} />

    <!-- Custom color picker -->
    <label class="focus-within:ring-2 focus-within:ring-primary rounded-full">
      <input id="customColor" name="customColor" type="color" class="sr-only peer" value="#694cf1" />
      <span id="customDot" class="color-dot bg-primary text-white flex items-center justify-center focus:outline-none" tabindex="0">
        <IconDisplay svgIcon="plus" svgSize="14" />
      </span>
    </label>
  </div>

  <!-- description -->
  <div class="w-full flex gap-2 items-stretch">
    <textarea name="description" rows="2" placeholder="Description" class="form-inout rounded-2xl py-2.5 h-auto"></textarea>
  </div>

  <!-- add todo / pomodoro btn -->
  <div class="w-full flex gap-2 items-stretch text-xs">
    <CapsuleBtn svgIcon="todo" svgSize="16" text="Add To-do Item" classList={[" w-full"]} action="addTodo" />
    <CapsuleBtn svgIcon="timer" svgSize="16" text="Pomodoro Timer" classList={[" w-full"]} action="addPomodoroTimer" id="addPomodoroTimerBtn" />
  </div>

  <!-- todo list -->
  <ul id="todoList" class="focus-primary hidden"></ul>

  <!-- pomodoro timer -->
  <AddPomodoroTimer />
  
  <!-- canccel / add task -->
  <div class="w-full flex justify-end gap-2 mt-2">
    <CapsuleBtnText type="button" text="Cancel" action="closeDialog" />
    <CapsuleBtnText type="submit" text="Add Task" classList={["bg-primary", "text-white"]} action="" />
  </div>
</form>

<AddTodo />

<script>
  // ── Days Select State Logic ────────────────────────────────────────────────
  const once = document.querySelector<HTMLInputElement>('[data-role="once"]');
  const everyDay = document.querySelector<HTMLInputElement>('[data-role="everyday"]');
  const days = Array.from(document.querySelectorAll<HTMLInputElement>('[data-role="day"]'));

  function checkedDays() {
    return days.filter((d) => d.checked);
  }

  function updateState(source: HTMLInputElement) {
    const checked = checkedDays();
    if (!once || !everyDay) return;
    // ── Once clicked ─────────────────────────────────────────────────────────
    if (source === once) {
      if (!once.checked && checked.length === 0) {
        // Once cannot be unchecked if nothing else is checked
        once.checked = true;
        return;
      }

      if (once.checked) {
        everyDay.checked = false;
        days.forEach((d) => (d.checked = false));
      }
    }

    // ── Every Day clicked ────────────────────────────────────────────────────
    if (source === everyDay) {
      if (everyDay.checked) {
        once.checked = false;
        days.forEach((d) => (d.checked = true));
      } else {
        days.forEach((d) => (d.checked = false));
        once.checked = true;
      }
    }

    // ── Any day clicked ──────────────────────────────────────────────────────

    if (source?.dataset.role === "day") {
      if (checked.length > 0) {
        once.checked = false;
      }

      if (checked.length === 0) {
        once.checked = true;
      }

      everyDay.checked = checked.length === days.length;
    }
  }

  const inputs = [once, everyDay, ...days].filter((el): el is HTMLInputElement => el !== null);

  inputs.forEach((input) => {
    input.addEventListener("change", () => updateState(input));
  });

  // ── Colors Select State Logic ──────────────────────────────────────────────

  const containerEl = document.getElementById("colorPicker");
  const customInputEl = document.getElementById("customColor");
  const customDotEl = document.getElementById("customDot");

  if (!(containerEl instanceof HTMLElement) || !(customInputEl instanceof HTMLInputElement) || !(customDotEl instanceof HTMLElement)) {
    throw new Error("Color picker elements not found");
  }

  const container = containerEl;
  const customInput = customInputEl;
  const customDot = customDotEl;

  const radios = Array.from(container.querySelectorAll<HTMLInputElement>('input[type="radio"]'));

  // Keyboard interaction
  container.addEventListener("keydown", (e: KeyboardEvent) => {
    if (e.key !== "Enter" && e.key !== " ") return;

    e.preventDefault();

    const target = e.target as HTMLElement | null;
    const input = target?.previousElementSibling;

    if (!(input instanceof HTMLInputElement)) return;

    if (input.type === "color") {
      radios.forEach((r) => (r.checked = false));
      customDot.classList.add("ring-2", "ring-primary");
      customDot.style.backgroundColor = input.value;
      input.focus();
    } else {
      input.checked = true;
      applyDefaultCustomColor();
      customDot.classList.remove("ring-2", "ring-primary");
    }

    input.dispatchEvent(new Event("change", { bubbles: true }));
  });

  // When a radio is selected → clear custom color
  radios.forEach((radio) => {
    radio.addEventListener("change", () => {
      applyDefaultCustomColor();
      customDot.classList.remove("ring-2", "ring-primary");
    });
  });

  // Utils
  function isLight(hex: string): boolean {
    const parts = hex.slice(1).match(/.{2}/g);
    if (!parts) return false;

    const [r, g, b] = parts.map((x) => parseInt(x, 16));
    return (r * 299 + g * 587 + b * 114) / 1000 > 180;
  }

  function applyDefaultCustomColor(): void {
    const color = customInput.value;
    customDot.style.backgroundColor = color;
    customDot.classList.toggle("text-primary", isLight(color));
    customDot.classList.toggle("text-white", !isLight(color));
  }

  // When custom color changes
  customInput.addEventListener("input", () => {
    radios.forEach((r) => (r.checked = false));
    applyDefaultCustomColor();
    customDot.classList.add("ring-2", "ring-primary");
  });

  // Public getter
  function getSelectedColor(): string {
    const checked = radios.find((r) => r.checked);
    return checked ? checked.value : customInput.value;
  }

  
</script>
